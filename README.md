# KaSe Keyboard Firmware

Custom firmware for the KaSe mechanical keyboard, built on an ESP32â€‘S3 with USB HID, Bluetooth HID, OLED display and multiâ€‘layer keymaps.

> Work in progress project. Open to ideas, feedback and contributions.

---

## Overview

This repository contains the **embedded firmware** for the KaSe custom keyboard:

- Runs on an **ESP32â€‘S3**.
- Handles key matrix scanning, layers, keymaps, display, USB/BLE HID, CDC ACM, storage.
- Designed to work together with two other repositories:
	- **Hardware / PCB / mechanics** â€“ `KaSe_PCB`  
		https://github.com/mornepousse/KaSe_PCB
	- **Desktop configuration & manager** â€“ `KaSe_soft`  
		https://github.com/mornepousse/KaSe_soft

For hardware details (exact MCU, pinout, schematics, mechanical design) and for the endâ€‘user configuration tool, please refer to those repositories.

---

## Related repositories

- **KaSe_PCB** â€“ Hardware, PCB and mechanical design  
	Contains:
	- Schematics and PCB layout.
	- MCU and component choices.
	- Pin mapping, connectors, and mechanical constraints.

	ðŸ‘‰ https://github.com/mornepousse/KaSe_PCB

- **KaSe_soft** â€“ Configuration / keymap manager  
	Desktop software to:
	- Remap keys and layers.
	- Manage configuration and other keyboard settings.
	- Communicate with this firmware over USB CDC ACM.

	ðŸ‘‰ https://github.com/mornepousse/KaSe_soft

This firmware repo focuses on the code running on the ESP32â€‘S3.

---

## Features

From the current codebase (still evolving, but already functional):

- **ESP32â€‘S3 keyboard core**
	- Key matrix scanning (`matrix.c`).
	- Keyboard logic and key handling (`keyboard_manager.c`, `keymap.c`).
	- Multiple layers with perâ€‘key mapping stored in NVS / LittleFS.

- **USB support (TinyUSB)**
	- USB HID keyboard implementation (`usb_descriptors.c`, TinyUSB HID class).
	- USB CDC ACM channel for:
		- Debug and logging.
		- Command and configuration interface (`cdc_acm_com.c`).

- **Bluetooth HID**
	- BLE HID device (`hid_bluetooth_manager.c`, `esp_hidd_prf_api.c`).
	- Wireless keyboard mode in addition to USB.

- **OLED display**
	- IÂ²C OLED driver (`i2c_oled_display.c`).
	- Shows current layer name and status text.

- **Storage**
	- LittleFS manager (`littlefs_manager.c`) for persistent storage.
	- Keymaps loaded at boot (`keymap_init_nvs()`, `load_keymaps()`).

- **Command interface over CDC ACM**
	- Parses simple text commands (`cdc_acm_com.c`), for example:
		- Set current layer.
		- Change a single key in a specific layer/row/column.
		- Display custom text on the OLED.
	- This protocol is used by the external tool **KaSe_soft**.

---

## Hardware

- **MCU**: ESP32â€‘S3 family.  
	Exact MCU reference, pinout and electrical details are defined in **KaSe_PCB**:  
	https://github.com/mornepousse/KaSe_PCB

- **Main peripherals** (inferred from the firmware):
	- Key matrix (rows/columns) managed by the `matrix` module.
	- IÂ²C OLED display (typical 128Ã—32 or 128Ã—64).
	- USB (likely USBâ€‘C or microâ€‘USB) for power and USB HID/CDC.
	- BLE radio (integrated in ESP32â€‘S3) for Bluetooth HID.

For precise BOM, schematics, mechanical parts and connector details, always refer to `KaSe_PCB`.

---

## Development environment

The project uses:

- **ESPâ€‘IDF** (v5.x) â€“ via the VS Code ESPâ€‘IDF extension.
- **VS Code** as main IDE.
- CMake + Ninja build system (generated by ESPâ€‘IDF).

Typical commandâ€‘line workflow with `idf.py`:

```bash
idf.py set-target esp32s3
idf.py build
idf.py flash
idf.py monitor
```

Make sure ESPâ€‘IDF is correctly installed and `IDF_PATH` is set before building.

---

## Configuration & usage

### Keymaps and layers

- Keymaps are initialized at boot:
	- `keymap_init_nvs()` for NVS setup.
	- `load_keymaps()` to load stored layouts.
- Data is stored in NVS / LittleFS so user configuration is persistent.
- Current layer is:
	- Sent over CDC (`cdc_send_layer()`).
	- Displayed on the OLED using the text functions in `i2c_oled_display.c`.

### CDC ACM command interface

- The firmware exposes a **CDC ACM** serial port over USB.
- Through this virtual COM port, you can:
	- Change the active layer.
	- Update individual keys: layer, row, column, value.
	- Send strings to be rendered on the OLED.
- Command syntax and higherâ€‘level UX are documented and implemented in **KaSe_soft**:  
	https://github.com/mornepousse/KaSe_soft

### Desktop configuration tool

For a userâ€‘friendly way to manage layouts and settings:

- Use **KaSe_soft**:
	- Provides a GUI/manager for layers and keymaps.
	- Talks to this firmware via the CDC ACM protocol.
- This README focuses on the firmware itself; `KaSe_soft` contains more endâ€‘user documentation.

---

## Project status & contributions

- This is an **active, workâ€‘inâ€‘progress** project:
	- Internal APIs and protocols may change.
	- New features (macros, advanced layouts, power optimizations, etc.) are planned.
- Contributions and ideas are welcome:
	- Firmware improvements or refactors.
	- New features (RGB, extra devices, better power management).
	- Documentation, examples, and tools around KaSe.

Note: commit history can be a bit erratic while the project is evolving; apologies in advance if some changes look noisy.

Feel free to open issues or pull requests. If your work touches hardware or the configuration tool, please reference `KaSe_PCB` and `KaSe_soft` when relevant.

---

## License

This project is licensed under **GPLâ€‘3.0** (GNU General Public License, version 3).  
See the `LICENSE` file at the root of this repository for the full legal text.

Short nonâ€‘legal explanation:

- GPL is a **copyleft** license:
	- Anyone can use, study, modify and redistribute the code.
	- If someone distributes a modified version (for example, their own KaSeâ€‘derived firmware), they must also publish their source code under the **same GPLâ€‘3.0 license**.
- This protects the project from being turned into a closedâ€‘source fork while keeping it open and hackable for the community.

---

## ðŸ‡«ðŸ‡· RÃ©sumÃ© en franÃ§ais

### PrÃ©sentation

KaSe Keyboard Firmware est le firmware du clavier mÃ©canique custom **KaSe**, basÃ© sur un **ESP32â€‘S3**, avec support **USB HID**, **Bluetooth HID**, **Ã©cran OLED** et **couches de keymaps configurables**.

Ce dÃ©pÃ´t contient uniquement le code embarquÃ©.  
Les autres parties du projet sont dans :

- MatÃ©riel / PCB / mÃ©canique : **KaSe_PCB**  
	https://github.com/mornepousse/KaSe_PCB
- Logiciel de remapping et gestion : **KaSe_soft**  
	https://github.com/mornepousse/KaSe_soft

Projet en cours de dÃ©veloppement, ouvert aux contributions et aux idÃ©es.

### FonctionnalitÃ©s

- Scan de matrice de touches, gestion des couches et keymaps persistants.
- USB HID clavier via TinyUSB + interface **CDC ACM** (commandes / debug).
- **Bluetooth HID** pour un mode clavier sans fil.
- Ã‰cran **OLED IÂ²C** pour afficher le layer courant et des infos.
- Stockage persistant (**NVS / LittleFS**) pour conserver la configuration.

### MatÃ©riel

- BasÃ© sur un **ESP32â€‘S3**.  
	Les dÃ©tails prÃ©cis (rÃ©fÃ©rence MCU, brochage, schÃ©mas, mÃ©canique) sont dÃ©crits dans `KaSe_PCB` :  
	https://github.com/mornepousse/KaSe_PCB

### DÃ©veloppement

- Environnement : **VS Code** + extension **ESPâ€‘IDF**.
- Build avec ESPâ€‘IDF (`idf.py`), CMake + Ninja.

Exemple de commandes :

```bash
idf.py set-target esp32s3
idf.py build
idf.py flash
idf.py monitor
```

### Configuration & remapping

- Les keymaps et couches sont stockÃ©es dans la mÃ©moire du clavier (NVS / LittleFS).
- Une interface **CDC ACM** permet dâ€™envoyer des commandes texte :
	- changement de layer,
	- remap dâ€™une touche,
	- affichage sur lâ€™OLED, etc.
- Pour une configuration plus confortable (outil PC), utiliser **KaSe_soft** :  
	https://github.com/mornepousse/KaSe_soft

### Licence & contributions

- Licence prÃ©vue : **GPLâ€‘3.0** (copyleft) :
	- Utilisation et modification libres.
	- Les dÃ©rivÃ©s distribuÃ©s doivent rester sous GPL et publier leurs sources.
- Projet orientÃ© maker et communautaire : issues, idÃ©es et PR sont les bienvenues pour amÃ©liorer le firmware, la doc et lâ€™Ã©cosystÃ¨me KaSe.

 
