# KaSe Keyboard Firmware

Custom firmware for the KaSe mechanical keyboard, built on an ESP32â€‘S3 with USB HID, Bluetooth HID, OLED display and multiâ€‘layer keymaps.

> Work in progress project. Open to ideas, feedback and contributions.

---

### Roadmap (short)

- ðŸš§ Bluetooth Screen mark

## Overview

This repository contains the **embedded firmware** for the KaSe custom keyboard:

- Runs on an **ESP32â€‘S3**.
- Handles key matrix scanning, layers, keymaps, display, USB/BLE HID, CDC ACM, storage.
- Designed to work together with two other repositories:
	- **Hardware / PCB / mechanics** â€“ `KaSe_PCB`  
		https://github.com/mornepousse/KaSe_PCB
	- **Desktop configuration & manager** â€“ `KaSe_soft`  
		https://github.com/mornepousse/KaSe_soft

For hardware details (exact MCU, pinout, schematics, mechanical design) and for the endâ€‘user configuration tool, please refer to those repositories.

---

## Related repositories

- **KaSe_PCB** â€“ Hardware, PCB and mechanical design  
	Contains:
	- Schematics and PCB layout.
	- MCU and component choices.
	- Pin mapping, connectors, and mechanical constraints.

	ðŸ‘‰ https://github.com/mornepousse/KaSe_PCB

- **KaSe_soft** â€“ Configuration / keymap manager  
	Desktop software to:
	- Remap keys and layers.
	- Manage configuration and other keyboard settings.
	- Communicate with this firmware over USB CDC ACM.

	ðŸ‘‰ https://github.com/mornepousse/KaSe_soft

This firmware repo focuses on the code running on the ESP32â€‘S3.

---

## Features

From the current codebase (still evolving, but already functional):

- **ESP32â€‘S3 keyboard core**
	- Key matrix scanning (`input/matrix.c`).
	- Keyboard logic and key handling (`input/keyboard_manager.c`, `input/keymap.c`).
	- Multiple layers with perâ€‘key mapping stored in NVS / LittleFS.

- **USB support (TinyUSB)**
	- USB HID keyboard implementation (`comm/usb_descriptors.c`, TinyUSB HID class).
	- USB CDC ACM channel for:
		- Debug and logging.
		- Command and configuration interface (`comm/cdc_acm_com.c`).

- **Bluetooth HID**
	- BLE HID device (`comm/hid_bluetooth_manager.c`, `comm/esp_hidd_prf_api.c`).
	- Wireless keyboard mode in addition to USB.

- **OLED display**
	- IÂ²C OLED driver and UI layer (`display/i2c_oled_display.c`, `display/status_display.c`).
	- Shows current layer name, transport icons and a boot splash with version info.

- **Storage**
	- LittleFS manager (`app/littlefs_manager.c`) for persistent storage.
	- Keymaps loaded at boot (`keymap_init_nvs()`, `load_keymaps()`).

- **Command interface over CDC ACM**
	- Parses simple text commands (`comm/cdc_acm_com.c`), for example:
		- Set current layer.
		- Change a single key in a specific layer/row/column.
		- Display custom text on the OLED.
	- This protocol is used by the external tool **KaSe_soft**.

---

## Hardware

- **MCU**: ESP32â€‘S3 family.  
	Exact MCU reference, pinout and electrical details are defined in **KaSe_PCB**:  
	https://github.com/mornepousse/KaSe_PCB

- **Main peripherals** (inferred from the firmware):
	- Key matrix (rows/columns) managed by the `matrix` module.
	- IÂ²C OLED display (typical 128Ã—32 or 128Ã—64).
	- USB (likely USBâ€‘C or microâ€‘USB) for power and USB HID/CDC.
	- BLE radio (integrated in ESP32â€‘S3) for Bluetooth HID.

For precise BOM, schematics, mechanical parts and connector details, always refer to `KaSe_PCB`.

---

## Project layout & development environment

```
main/
â”œâ”€â”€ app/        # high-level tasks (main, filesystem, dfu)
â”œâ”€â”€ input/      # matrix scan, keyboard manager, keymaps
â”œâ”€â”€ display/    # OLED drivers, status UI and assets
â”œâ”€â”€ comm/       # USB/BLE stacks, CDC commands
â”œâ”€â”€ include/    # shared headers (display types, configs)
â””â”€â”€ CMakeLists.txt / idf_component.yml
```

The project uses:

- **ESPâ€‘IDF** (v5.x) â€“ via the VS Code ESPâ€‘IDF extension.
- **VS Code** as main IDE.
- CMake + Ninja build system (generated by ESPâ€‘IDF).

Typical commandâ€‘line workflow with `idf.py`:

```bash
idf.py set-target esp32s3
idf.py build
idf.py flash
idf.py monitor
```

Make sure ESPâ€‘IDF is correctly installed and `IDF_PATH` is set before building.

---

## Configuration & usage

### Keymaps and layers

- Keymaps are initialized at boot:
	- `keymap_init_nvs()` for NVS setup.
	- `load_keymaps()` to load stored layouts.
- Data is stored in NVS / LittleFS so user configuration is persistent.
- Current layer is:
	- Sent over CDC (`cdc_send_layer()`).
	- Displayed on the OLED using the text functions in `i2c_oled_display.c`.

### OLED splash and status

- On boot the OLED shows the firmware name + version (from `PRODUCT_NAME` / `GATTS_TAG`) for roughly two seconds before the UI transitions to real-time status.
- The steady-state screen exposes the active layer, USB/BLE transport icon, and Bluetooth link status so users can quickly confirm connectivity.
- After ~60 seconds of inactivity the display sleeps automatically and wakes on the next key press to avoid burn-in while staying responsive.

### CDC ACM command interface

- The firmware exposes a **CDC ACM** serial port over USB.
- Through this virtual COM port, you can:
	- Change the active layer.
	- Update individual keys: layer, row, column, value.
	- Send strings to be rendered on the OLED.
- Command syntax and higherâ€‘level UX are documented and implemented in **KaSe_soft**:  
	https://github.com/mornepousse/KaSe_soft

### Desktop configuration tool

For a userâ€‘friendly way to manage layouts and settings:

- Use **KaSe_soft**:
	- Provides a GUI/manager for layers and keymaps.
	- Talks to this firmware via the CDC ACM protocol.
- This README focuses on the firmware itself; `KaSe_soft` contains more endâ€‘user documentation.

---

## Project status & contributions

- This is an **active, workâ€‘inâ€‘progress** project:
	- Internal APIs and protocols may change.
	- New features (macros, advanced layouts, power optimizations, etc.) are planned.
- Contributions and ideas are welcome:
	- Firmware improvements or refactors.
	- New features (RGB, extra devices, better power management).
	- Documentation, examples, and tools around KaSe.

Note: commit history can be a bit erratic while the project is evolving; apologies in advance if some changes look noisy.

Feel free to open issues or pull requests. If your work touches hardware or the configuration tool, please reference `KaSe_PCB` and `KaSe_soft` when relevant.

---

## License

This project is licensed under **GPLâ€‘3.0** (GNU General Public License, version 3).  
See the `LICENSE` file at the root of this repository for the full legal text.

Short nonâ€‘legal explanation:

- GPL is a **copyleft** license:
	- Anyone can use, study, modify and redistribute the code.
	- If someone distributes a modified version (for example, their own KaSeâ€‘derived firmware), they must also publish their source code under the **same GPLâ€‘3.0 license**.
- This protects the project from being turned into a closedâ€‘source fork while keeping it open and hackable for the community.

---

